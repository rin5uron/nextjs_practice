# M2: `scripts/gemini-reply.js` の実装ガイド
完了日：2025/8/16
- 何しているか半分以上よくわからない
<br>
このドキュメントは、マイルストーン2（M2）であなたが`scripts/gemini-reply.js`をどのように実装すべきか、具体的な手順を説明します。これはgeminiがissueからやることを読み取ってファイル変更やコマンドを実行するために必要な設定をする。応答

## M2の目標

Geminiが生成した「ファイル変更」や「コマンド実行」の指示を、`scripts/gemini-reply.js`が正確に解析し、実際に実行できるようにすること。`FILE_CHANGE:`と`RUN_COMMAND:`で実行するように設定する。


## 実装手順

### ステップ1: Geminiの応答の骨格を定める
コード生成とコマンド実行のために
Geminiからの応答テキスト（`response.text()`で取得される文字列）に、`FILE_CHANGE:`と`RUN_COMMAND:`といった指示を定義する。これらの指示を一つずつ取り出し、種類と内容を識別できるようにします。Geminiが応答テキストを生成する際に、`FILE_CH
  ANGE:`や`RUN_COMMAND:`といった定義された形式（ルール）に従って指示を記述する、というルールを定める。

**やるべきこと:**

1.  `scripts/gemini-reply.js`の`run`関数内で、`const text = response.text();` の後に、`text`を解析するロジックを追加します。
2.  **指示の分割:** Geminiが複数の指示を返す場合を考慮し、各指示を個別の行として処理できるようにします。例えば、改行（`\n`）でテキストを分割することを検討してください。
3.  **指示の識別と内容の抽出:**
    *   各行が`FILE_CHANGE:`で始まるか、`RUN_COMMAND:`で始まるかをチェックします。
    *   `FILE_CHANGE:`の場合、ファイルパスとファイル内容を抽出します。
        *   例: `FILE_CHANGE: src/components/Button.tsx: export const Button = () => <button>Click me</button>;`
        *   この行から`src/components/Button.tsx`と`export const Button = () => <button>Click me</button>;`を抽出します。
    *   `RUN_COMMAND:`の場合、実行するコマンドを抽出します。
        *   例: `RUN_COMMAND: bun install`
        *   この行から`bun install`を抽出します。

**ヒント:** JavaScriptの`startsWith()`, `substring()`, `indexOf()`, `split()`などの文字列操作メソッドが役立ちます。

### ステップ2: `FILE_CHANGE`指示を実行する

解析した`FILE_CHANGE`指示に基づいて、実際にファイルを書き込みます。

**やるべきこと:**

1.  Node.jsの`fs`モジュールを使用します。
    *   ファイルの書き込みには`fs.writeFileSync(filePath, fileContent)`を使います。
    *   **重要:** ファイルパスのディレクトリが存在しない場合、エラーになります。`fs.mkdirSync(path.dirname(filePath), { recursive: true })`を使って、必要に応じて親ディレクトリを再帰的に作成するロジックを追加してください。`path`モジュールも必要になります。
    ```
    fsが「ファイルを読み書きしたり、ディレクトリを作ったりする道具」、pathが「ファイルパスを便利に扱う道具」
    ```

### ステップ3: `RUN_COMMAND`指示を実行する

解析した`RUN_COMMAND`指示に基づいて、実際にコマンドを実行します。

**やるべきこと:**

1.  Node.jsの`child_process`モジュールを使用します。
    *   コマンドの実行には`child_process.execSync(command)`を使います。
    *   コマンドの標準出力やエラー出力をコンソールに表示すると、デバッグに役立ちます。

### ステップ4: エラーハンドリングとログ出力

各ステップでエラーが発生した場合に適切に処理し、進捗や結果をログに出力するようにします。

**やるべきこと:**

1.  ファイル操作やコマンド実行の周りに`try...catch`ブロックを追加し、エラーが発生した場合は適切なメッセージをコンソールに出力します。
2.  各指示が正常に処理されたことを示すメッセージも出力すると良いでしょう。

---

**次のアクション:**

上記のガイドを参考に、`scripts/gemini-reply.js`を編集してください。
不明な点があれば、いつでも質問してください。