# Next.js 開発サーバーのポート管理とプロセス制御

Next.jsでの開発時によく遭遇するポートの問題と、開発サーバーの正しい停止方法についてまとめます。

## 1. ポート番号の変更方法

開発サーバーを起動するポート番号は、恒久的に、または一時的に変更することができます。

### ポート番号が決まる仕組み
`bun dev` (または `npm run dev`) で使用されるポート番号は、他のプロジェクトや過去の実行履歴に影響されません。常に、**現在作業しているプロジェクトの `package.json` に書かれている `dev` スクリプトの記述**によって決まります。

- **`"dev": "next dev"` の場合:** **必ず** デフォルトの `3000` 番ポートが使われます。
- **`"dev": "next dev -p 3030"` の場合:** **必ず** `3030` 番ポートが使われます。

振る舞いは `package.json` の記述通りで、曖昧さはありません。

### 方法1: `package.json` を書き換える（恒久的な変更）

プロジェクトのデフォルトポートを恒久的に変更する場合、`package.json` ファイルの `scripts` セクションを編集します。

**例1: 別のポート（例: 4000）に変更する場合**

```json
// Before
"scripts": {
  "dev": "next dev"
}

// After
"scripts": {
  "dev": "next dev -p 4000"
}
```

**例2: デフォルトのポート `3000` に戻す場合**

ポート番号を指定している `-p <ポート番号>` の部分を完全に削除します。

```json
// Before: ポート3030が指定されている状態
"scripts": {
  "dev": "next dev -p 3030"
}

// After: デフォルトのポート3000を使う設定
"scripts": {
  "dev": "next dev"
}
```

### 方法2: コマンド実行時に一時的に指定する

`package.json` を変更せず、サーバーを起動する時だけポートを変更する方法です。

```bash
# ポート4000で一時的に起動したい場合
bun dev -- -p 4000
```
**ポイント:** `bun dev` の後に `--` を入れることで、`-p 4000` が `bun` ではなく `next dev` コマンドに渡されます。

---

## 2. 開発サーバーの停止方法 (`Ctrl+C` と `kill` コマンド)

### 基本的な停止方法: `Ctrl+C`

開発サーバーは、実行中のターミナルで `Ctrl+C` を押すことで停止するのが基本です。

- **役割:** 実行中のプロセスに対して「終了してください」という丁寧な割り込み信号 (`SIGINT`) を送ります。
- **使い方:** サーバーが動いているターミナルの画面で `Ctrl` キーと `C` キーを同時に押します。

### 応用: `Ctrl+C` で終了しない場合の強制停止方法

`Ctrl+C` を押してもターミナルが反応しない、または `EADDRINUSE` エラーが解消されない場合は、プロセスが裏で生き残っている（ゾンビプロセス化）可能性があります。その場合は、以下の手順で手動でプロセスを停止させます。

**手順1: ポートを使用中のプロセスを特定する**

`lsof` (List Open Files) コマンドで、指定したポートをどのプロセスが使っているか特定します。

```bash
# ポート3000を使用しているプロセスを調べる
lsof -i :3000
```
実行結果から、`PID` (プロセスID) の列にある数字を控えます。

**手順2: プロセスを終了する (`kill`)**

特定した `PID` を使って、`kill` コマンドでプロセスに終了信号を送ります。

```bash
# PIDが 41687 の場合
kill 41687
```
これは `Ctrl+C` より少し強い `SIGTERM` という信号を送り、プロセスに終了を促します。ほとんどの場合はこれで終了します。

**手順3: プロセスを強制終了する (`kill -9`)**

`kill` コマンドでも終了しない、しつこいプロセスのための最終手段です。

```bash
# PIDが 41687 の場合
kill -9 41687
```
これは `SIGKILL` という強制終了信号を送り、OSがプロセスを問答無用で停止させます。データの保存中などに関わらず終了するため、最終手段として使用してください。